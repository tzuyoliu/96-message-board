<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Let's Talk</title>
    <link rel="icon" type="image/x-icon" href="./favicon.ico">
    <style>
        /* 全局樣式：響應式、行動優先、深淺色自適應，統一字體 */
        :root {
            --bg-color: #f0f0f0;
            --text-color: #000000;
            --bubble-left: #e5e5ea;
            --bubble-right: #007aff;
            --bubble-text-left: #000000;
            --bubble-text-right: #ffffff;
            --timestamp-color: #8e8e93;
            --input-bg: #ffffff;
            --input-border: #c7c7cc;
            --button-bg: #007aff;
            --button-text: #ffffff;
            --mosaic-bg: rgba(0, 0, 0, 0.5);
            --reply-1: #BBA86C;
            --reply-2: #7EAD7C;
            --reply-3: #BD6478;
            --reply-4: #D54950;
            --reply-5: #2E1F25;
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --bg-color: #1c1c1e;
                --text-color: #ffffff;
                --bubble-left: #2c2c2e;
                --bubble-right: #0a84ff;
                --bubble-text-left: #ffffff;
                --bubble-text-right: #ffffff;
                --timestamp-color: #8e8e93;
                --input-bg: #2c2c2e;
                --input-border: #3a3a3c;
                --button-bg: #0a84ff;
                --button-text: #ffffff;
                --mosaic-bg: rgba(255, 255, 255, 0.5);
            }
        }

        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }

        #messages {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .message {
            max-width: 80%;
            padding: 10px 15px;
            border-radius: 20px;
            font-size: 16px;
            line-height: 1.4;
            position: relative;
            word-break: break-word;
            overflow-wrap: break-word;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        .message.left {
            background-color: var(--bubble-left);
            color: var(--bubble-text-left);
            align-self: flex-start;
            border-bottom-left-radius: 5px;
        }

        .message.right {
            background-color: var(--bubble-right);
            color: var(--bubble-text-right);
            align-self: flex-end;
            border-bottom-right-radius: 5px;
        }

        .message.reply-1 { background-color: var(--reply-1); color: #ffffff; }
        .message.reply-2 { background-color: var(--reply-2); color: #ffffff; }
        .message.reply-3 { background-color: var(--reply-3); color: #ffffff; }
        .message.reply-4 { background-color: var(--reply-4); color: #ffffff; }
        .message.reply-5 { background-color: var(--reply-5); color: #ffffff; }

        .message.reply {
            margin-left: 20px;
        }

        .timestamp {
            font-size: 12px;
            color: var(--timestamp-color);
            margin-top: 5px;
            text-align: right;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        .message.left .timestamp {
            text-align: left;
        }

        .message.mosaic {
            filter: blur(5px);
            user-select: none;
        }

        .message img {
            max-width: 100%;
            max-height: 200px;
            border-radius: 10px;
            margin-top: 5px;
        }

        .url-preview {
            margin-top: 5px;
            padding: 8px;
            border: 1px solid var(--input-border);
            border-radius: 10px;
            background-color: var(--input-bg);
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .url-preview iframe {
            width: 100%;
            height: 200px;
            border: none;
            border-radius: 10px;
        }

        .url-preview .twitter-tweet {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            color: var(--text-color);
            padding: 10px;
            border: 1px solid var(--input-border);
            border-radius: 10px;
            background-color: var(--bubble-left);
            max-width: 100%;
        }

        .url-preview .twitter-tweet p {
            margin: 0 0 10px 0;
            font-size: 14px;
        }

        .url-preview .twitter-tweet a {
            color: var(--button-bg);
            text-decoration: none;
            font-size: 12px;
        }

        .url-preview .twitter-tweet .tweet-header {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }

        .url-preview .twitter-tweet .tweet-header img {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            margin-right: 10px;
        }

        .url-preview .twitter-tweet .tweet-header span {
            font-weight: bold;
        }

        .url-preview .twitter-tweet .tweet-footer {
            font-size: 12px;
            color: var(--timestamp-color);
        }

        #input-area {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            padding: 10px;
            background-color: var(--bg-color);
            border-top: 1px solid var(--input-border);
            gap: 10px;
            position: relative;
        }

        #message-input {
            flex: 1;
            padding: 10px;
            border: 1px solid var(--input-border);
            border-radius: 20px;
            background-color: var(--input-bg);
            color: var(--text-color);
            font-size: 16px;
            resize: none;
            min-height: 40px;
            max-height: 100px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        #char-counter {
            position: absolute;
            bottom: 10px;
            right: 10px;
            font-size: 12px;
            color: var(--timestamp-color);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        #mosaic-checkbox {
            margin: 0 5px;
        }

        label {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        button {
            padding: 10px 15px;
            background-color: var(--button-bg);
            color: var(--button-text);
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-size: 20px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .reply-btn {
            font-size: 12px;
            color: var(--timestamp-color);
            cursor: pointer;
            margin-top: 5px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        .mosaic-btn {
            font-size: 12px;
            color: #ffffff;
            cursor: pointer;
            margin-left: 10px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        #scroll-to-bottom {
            position: fixed;
            bottom: 80px;
            right: 20px;
            background-color: rgba(0, 0, 0, 0.3);
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            opacity: 0.5;
            transition: opacity 0.3s;
            display: none;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        #scroll-to-bottom:hover {
            opacity: 1;
        }

        #admin-toggle {
            position: fixed;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            padding: 10px;
            background: rgba(0, 0, 0, 0.1);
            color: var(--button-text);
            border-radius: 50%;
            cursor: pointer;
            font-size: 24px;
            z-index: 1000;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        @media (max-width: 600px) {
            #messages {
                padding: 5px;
            }
            .message {
                max-width: 90%;
            }
            #input-area {
                flex-direction: column-reverse;
                align-items: stretch;
                padding-bottom: 60px;
            }
            #message-input {
                flex: 2;
            }
            #mosaic-checkbox, label {
                margin-top: 5px;
            }
            button {
                padding: 10px 15px;
                order: 1;
                margin-top: 10px;
            }
        }
    </style>
</head>
<body>
    <div id="admin-toggle" onclick="toggleAdminMode()">≡</div>
    <div id="messages"></div>
    <div id="input-area">
        <textarea id="message-input" placeholder="익명으로 메시지를 보내기"></textarea>
        <label>
            <input type="checkbox" id="mosaic-checkbox">
            모자이크
        </label>
        <button onclick="sendMessage()">↑</button>
        <div id="char-counter"></div>
    </div>
    <button id="scroll-to-bottom" onclick="scrollToBottom()">↓</button>

    <script>
        // ---- Supabase integration ----
        const supabaseUrl = 'https://nkfgremeepozsagjzhaw.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5rZmdyZW1lZXBvenNhZ2p6aGF3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUyMzQyMTAsImV4cCI6MjA3MDgxMDIxMH0._i6mzzmWqPXAhc6NM8pZdVEeIBpxVtv8-L0RdFuwjlo';
        const { createClient } = (function() {
            return {
                createClient: (url, key) => ({
                    from: (table) => ({
                        select: () => ({
                            order: (field, { ascending }) => ({
                                then: async (cb) => {
                                    try {
                                        const response = await fetch(`${url}/rest/v1/${table}?select=*&order=${field}.${ascending ? 'asc' : 'desc'}`, {
                                            headers: { apikey: key, Authorization: `Bearer ${key}` },
                                            mode: 'cors',
                                            credentials: 'include'
                                        });
                                        if (!response.ok) {
                                            console.error(`Fetch failed for ${table}:`, response.status, response.statusText);
                                            throw new Error(`HTTP error! status: ${response.status}`);
                                        }
                                        const { data, error } = await response.json();
                                        if (!error) cb({ data });
                                        else console.error(`Select error for ${table}:`, error);
                                    } catch (error) {
                                        console.error(`Network error for ${table}:`, error);
                                    }
                                }
                            }),
                            limit: (n) => ({
                                single: () => ({
                                    then: async (cb) => {
                                        try {
                                            const response = await fetch(`${url}/rest/v1/${table}?select=*&limit=1`, {
                                                headers: { apikey: key, Authorization: `Bearer ${key}` },
                                                mode: 'cors',
                                                credentials: 'include'
                                            });
                                            if (!response.ok) {
                                                console.error(`Fetch failed for ${table} limit 1:`, response.status, response.statusText);
                                                throw new Error(`HTTP error! status: ${response.status}`);
                                            }
                                            const { data, error } = await response.json();
                                            if (!error) cb({ data: data[0] });
                                            else console.error(`Limit error for ${table}:`, error);
                                        } catch (error) {
                                            console.error(`Network error for ${table} limit 1:`, error);
                                        }
                                    }
                                })
                            })
                        }),
                        insert: async (data) => {
                            try {
                                console.log('Inserting data:', data); // Debug
                                const response = await fetch(`${url}/rest/v1/${table}`, {
                                    method: 'POST',
                                    headers: { apikey: key, Authorization: `Bearer ${key}`, 'Content-Type': 'application/json' },
                                    body: JSON.stringify(data),
                                    mode: 'cors',
                                    credentials: 'include'
                                });
                                if (!response.ok) {
                                    console.error(`Insert failed for ${table}:`, response.status, response.statusText);
                                    throw new Error(`HTTP error! status: ${response.status}`);
                                }
                                const { data: insertedData, error } = await response.json();
                                return { data: insertedData, error };
                            } catch (error) {
                                console.error(`Network error for ${table} insert:`, error);
                                return { error };
                            }
                        },
                        update: async (data) => ({
                            eq: (field, value) => ({
                                then: async (cb) => {
                                    try {
                                        const response = await fetch(`${url}/rest/v1/${table}?${field}=eq.${value}`, {
                                            method: 'PATCH',
                                            headers: { apikey: key, Authorization: `Bearer ${key}`, 'Content-Type': 'application/json' },
                                            body: JSON.stringify(data),
                                            mode: 'cors',
                                            credentials: 'include'
                                        });
                                        if (!response.ok) {
                                            console.error(`Update failed for ${table}:`, response.status, response.statusText);
                                            throw new Error(`HTTP error! status: ${response.status}`);
                                        }
                                        const { data: updatedData, error } = await response.json();
                                        if (!error) cb({ data: updatedData });
                                        else console.error(`Update error for ${table}:`, error);
                                    } catch (error) {
                                        console.error(`Network error for ${table} update:`, error);
                                    }
                                }
                            })
                        })
                    }),
                    auth: {
                        signInWithOAuth: async () => {
                            console.log('Redirecting to GitHub login...');
                            window.location.href = `${supabaseUrl}/auth/v1/authorize?provider=github&redirect_to=${window.location.origin}`;
                            return { user: null };
                        },
                        signOut: async () => {
                            await fetch(`${supabaseUrl}/auth/v1/logout`, {
                                method: 'POST',
                                headers: { apikey: supabaseKey, Authorization: `Bearer ${supabaseKey}` },
                                credentials: 'include'
                            });
                            window.location.reload();
                        },
                        getSession: async () => {
                            try {
                                const response = await fetch(`${supabaseUrl}/auth/v1/user`, {
                                    headers: { apikey: supabaseKey, Authorization: `Bearer ${supabaseKey}` },
                                    mode: 'cors',
                                    credentials: 'include'
                                });
                                if (!response.ok) {
                                    console.error('Session fetch failed:', response.status, response.statusText);
                                    throw new Error(`HTTP error! status: ${response.status}`);
                                }
                                const { user, error } = await response.json();
                                console.log('Session data:', { user, error });
                                return { data: { session: { user, error } } };
                            } catch (error) {
                                console.error('Network error for session:', error);
                                return { data: { session: { user: null, error } } };
                            }
                        }
                    }
                })
            };
        })();
        const supabase = createClient(supabaseUrl, supabaseKey);

        // ---- state & storage ----
        let messages = [];
        let lastSendTime = 0;
        let isAdminMode = false;
        let replyingTo = null;
        let replyLevel = 0;
        let lastActivityTime = Date.now();
        const INACTIVITY_THRESHOLD = 5 * 60 * 1000;
        const MAX_CHARS = 1000;
        const ADMIN_USER_ID = '68b6ba43-1cb7-4bea-a846-e10de0beee34';

        // ---- initialize ----
        (async () => {
            await loadMessages();
            if (messages.length === 0) {
                const seedData = [
                    { content: '這是左邊的假訊息，從別人發的。', side: 'left', timestamp: new Date().toLocaleString('ko-KR', { timeZone: 'Asia/Seoul' }), mosaic: false, parentId: null, level: 0, image: null },
                    { content: '這是右邊的父留言。', side: 'right', timestamp: new Date().toLocaleString('ko-KR', { timeZone: 'Asia/Seoul' }), mosaic: false, parentId: null, level: 0, image: null },
                    { content: '子留言 1 (應顯示)。', side: 'left', timestamp: new Date().toLocaleString('ko-KR', { timeZone: 'Asia/Seoul' }), mosaic: false, parentId: 2, level: 1, image: null },
                    { content: '子留言 2 (應隱藏，因只顯示 1 則)。', side: 'right', timestamp: new Date().toLocaleString('ko-KR', { timeZone: 'Asia/Seoul' }), mosaic: false, parentId: 2, level: 1, image: null },
                    { content: '這是 모자이크 訊息，包含 YouTube：https://youtu.be/dQw4w9WgXcQ。', side: 'left', timestamp: new Date().toLocaleString('ko-KR', { timeZone: 'Asia/Seoul' }), mosaic: true, parentId: null, level: 0, image: null },
                    { content: 'https://x.com/elonmusk/status/1234567890123456789', side: 'right', timestamp: new Date().toLocaleString('ko-KR', { timeZone: 'Asia/Seoul' }), mosaic: false, parentId: null, level: 0, image: null }
                ];
                const { error } = await supabase.from('messages').insert(seedData);
                if (error) console.error('Seed data insert error:', error);
                else await loadMessages();
            }
        })();

        // ---- load messages ----
        async function loadMessages() {
            const { data, error } = await supabase.from('messages').select('*').order('timestamp', { ascending: false });
            if (!error) {
                messages = data || [];
                renderMessages();
            } else {
                console.error('載入訊息失敗:', error.message || error);
            }
        }

        // ---- render messages ----
        function getReplyLevel(msgId) {
            let level = 0;
            let currentId = msgId;
            while (currentId) {
                const msg = messages.find(m => m.id === currentId);
                if (!msg || !msg.parentId) break;
                level++;
                currentId = msg.parentId;
            }
            return level;
        }

        function renderMessages() {
            const container = document.getElementById('messages');
            container.innerHTML = '';
            messages.filter(m => !m.parentId).forEach(parent => {
                renderMessage(parent, container);
                renderReplies(parent.id, container, 1);
            });
            scrollToBottom();
            container.addEventListener('scroll', toggleScrollButton);
            toggleScrollButton();
        }

        function renderReplies(parentId, container, level) {
            if (level > 5) return;
            const child = messages.find(m => m.parentId === parentId);
            if (child) {
                renderMessage(child, container, level);
                renderReplies(child.id, container, level + 1);
            }
        }

        function renderMessage(msg, container, level = 0) {
            const div = document.createElement('div');
            const isReply = level > 0;
            div.className = `message ${msg.side} ${isReply ? `reply reply-${level}` : ''} ${msg.mosaic && !isAdminMode ? 'mosaic' : ''}`;
            const escapedContent = escapeHtml(msg.content);
            let contentHtml = `<div class="content">${escapedContent}</div>`;

            // 網址預覽
            const urlRegex = /(https?:\/\/[^\s]+)/g;
            const urls = msg.content.match(urlRegex) || [];
            if (urls.length > 0) {
                urls.forEach(url => {
                    const youtubeId = extractYouTubeId(url);
                    if (youtubeId) {
                        contentHtml += `
                            <div class="url-preview">
                                <iframe src="https://www.youtube.com/embed/${youtubeId}" frameborder="0" allowfullscreen></iframe>
                            </div>`;
                    } else if (url.includes('x.com')) {
                        const tweetId = extractTweetId(url);
                        contentHtml += `
                            <div class="url-preview">
                                <blockquote class="twitter-tweet">
                                    <div class="tweet-header">
                                        <img src="https://x.com/favicon.ico" alt="Twitter Profile">
                                        <span>@elonmusk</span>
                                    </div>
                                    <p>模擬推文內容 (ID: ${tweetId})</p>
                                    <div class="tweet-footer">2025-08-15 16:26 (KST)</div>
                                    <a href="${url}" target="_blank">View on X</a>
                                </blockquote>
                            </div>`;
                    }
                });
            }

            if (msg.image) {
                contentHtml += `<img src="${msg.image}" alt="Pasted image">`;
            }

            div.innerHTML = `
                ${contentHtml}
                <div class="timestamp">${msg.timestamp}</div>
                ${level < 5 ? `<span class="reply-btn" onclick="toggleReply(${msg.id}, ${level + 1})">reply</span>` : ''}
            `;

            // Admin 模式下所有留言顯示馬賽克切換按鈕
            if (isAdminMode) {
                const mosaicBtn = document.createElement('span');
                mosaicBtn.className = 'mosaic-btn';
                mosaicBtn.textContent = msg.mosaic ? '公開' : '隱藏';
                mosaicBtn.onclick = () => toggleMosaic(msg.id);
                div.appendChild(mosaicBtn);
            }

            container.appendChild(div);
        }

        // ---- send message ----
        async function sendMessage() {
            const input = document.getElementById('message-input');
            const content = input.value.trim();
            const mosaic = document.getElementById('mosaic-checkbox').checked;

            if (!content && !pastedImage) return;

            const now = Date.now();
            if (now - lastSendTime < 5000) {
                alert('請等待 5 秒後再發送');
                return;
            }

            // ---- spam url check ----
            const spamPatterns = [
                /download/i, /app\.exe/i, /apk/i, /store\/app/i, /advert/i,
                /rb\.gy|t\.co/i
            ];
            if (content) {
                const hasSpam = spamPatterns.some(pattern => pattern.test(content));
                if (hasSpam) {
                    alert('No Spam Link !!');
                    input.style.color = '#ff0000';
                    input.style.textDecoration = 'line-through line-through';
                    setTimeout(() => {
                        input.style.color = '';
                        input.style.textDecoration = '';
                        input.value = '';
                    }, 2000);
                    return;
                }
            }

            if (content.length > MAX_CHARS) {
                alert(`訊息超過 ${MAX_CHARS} 字元上限！`);
                return;
            }

            const { data: { session } } = await supabase.auth.getSession();
            if (!session) {
                alert('請先登入！');
                supabase.auth.signInWithOAuth();
                return;
            }

            console.log('Sending message:', { content, mosaic, parentId: replyingTo, user_id: session.user.id }); // Debug
            const wasInactive = now - lastActivityTime > INACTIVITY_THRESHOLD;
            const newMessage = {
                content: content || '',
                side: 'right',
                timestamp: new Date().toLocaleString('ko-KR', { timeZone: 'Asia/Seoul' }),
                mosaic,
                parentId: replyingTo,
                level: replyLevel,
                image: pastedImage,
                user_id: session.user.id
            };

            const { data, error } = await supabase.from('messages').insert(newMessage).select();
            if (error) {
                alert('發送失敗，請稍後重試: ' + (error.message || error));
                console.error('Insert error:', error);
                return;
            }

            messages.push(data[0]);
            renderMessages();

            if (wasInactive) {
                simulateEmailNotification(data[0]);
            }

            document.getElementById('message-input').value = '';
            document.getElementById('mosaic-checkbox').checked = false;
            pastedImage = null;
            replyingTo = null;
            replyLevel = 0;
            document.getElementById('message-input').placeholder = '익명으로 메시지를 보내기';
            lastSendTime = now;
            lastActivityTime = now;
        }

        // ---- toggle mosaic ----
        async function toggleMosaic(id) {
            const msg = messages.find(m => m.id === id);
            if (msg) {
                console.log('Toggling mosaic for id:', id, 'new value:', !msg.mosaic); // Debug
                const { error } = await supabase.from('messages').update({ mosaic: !msg.mosaic }).eq('id', id);
                if (error) {
                    console.error('Update error:', error.message || error);
                } else {
                    msg.mosaic = !msg.mosaic;
                    renderMessages();
                }
            }
        }

        // ---- image paste handling ----
        let pastedImage = null;
        document.getElementById('message-input').addEventListener('paste', (e) => {
            const items = e.clipboardData.items;
            for (const item of items) {
                if (item.type.startsWith('image/')) {
                    e.preventDefault();
                    const file = item.getAsFile();
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        pastedImage = event.target.result;
                    };
                    reader.readAsDataURL(file);
                }
            }
        });

        // ---- reply functionality ----
        function toggleReply(id, level) {
            if (replyingTo === id) {
                replyingTo = null;
                replyLevel = 0;
                document.getElementById('message-input').placeholder = '익명으로 메시지를 보내기';
            } else {
                replyingTo = id;
                replyLevel = level;
                document.getElementById('message-input').placeholder = `reply ${level}...`;
            }
            document.getElementById('message-input').focus();
        }

        // ---- admin view ----
        async function toggleAdminMode() {
            const { data: { session } } = await supabase.auth.getSession();
            console.log('Toggle Admin Mode - Session:', session); // Debug
            if (session && session.user.id === ADMIN_USER_ID) {
                isAdminMode = !isAdminMode;
                document.getElementById('admin-toggle').textContent = isAdminMode ? '退出 Admin 模式' : '≡';
                renderMessages();
            } else {
                alert('僅限 Admin 用戶切換模式！請登入。');
                if (!session) {
                    console.log('No session, triggering login...');
                    supabase.auth.signInWithOAuth();
                }
            }
        }

        // ---- utility functions ----
        function saveMessages() {
            localStorage.setItem('messages', JSON.stringify(messages));
        }

        function escapeHtml(unsafe) {
            return unsafe
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        function scrollToBottom() {
            const container = document.getElementById('messages');
            container.scrollTop = container.scrollHeight;
        }

        function toggleScrollButton() {
            const container = document.getElementById('messages');
            const btn = document.getElementById('scroll-to-bottom');
            if (container.scrollHeight - container.scrollTop - container.clientHeight > 100) {
                btn.style.display = 'flex';
            } else {
                btn.style.display = 'none';
            }
        }

        function extractYouTubeId(url) {
            const regex = /(?:youtube\.com\/watch\?v=|youtu\.be\/)([a-zA-Z0-9_-]+)/;
            const match = url.match(regex);
            return match ? match[1] : '';
        }

        function extractTweetId(url) {
            const regex = /status\/(\d+)/;
            const match = url.match(regex);
            return match ? match[1] : '';
        }

        // ---- email notification simulation ----
        function simulateEmailNotification(message) {
            console.log(`模擬 Email 通知寄往 tynntsai@gmail.com:
主旨: 新留言通知
內容: 新訊息於 ${message.timestamp}
${message.content ? `文字: ${message.content}` : ''}
${message.image ? '包含圖片' : ''}`);
        }

        // ---- textarea enter key handling ----
        document.getElementById('message-input').addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
            }
            updateCharCounter();
        });

        // ---- esc key handling for cancel reply ----
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && replyingTo !== null) {
                replyingTo = null;
                replyLevel = 0;
                document.getElementById('message-input').placeholder = '익명으로 메시지를 보내기';
            }
        });

        // ---- character counter ----
        function updateCharCounter() {
            const input = document.getElementById('message-input');
            const charCount = input.value.length;
            const counter = document.getElementById('char-counter');
            if (charCount >= 801) {
                counter.textContent = `${charCount}/${MAX_CHARS}`;
            } else {
                counter.textContent = '';
            }
            if (charCount > MAX_CHARS) {
                input.value = input.value.substring(0, MAX_CHARS);
                counter.textContent = `${MAX_CHARS}/${MAX_CHARS}`;
            }
        }

        // 初始渲染
        document.getElementById('message-input').addEventListener('input', updateCharCounter);
        (async () => {
            await loadMessages();
            if (messages.length === 0) {
                const seedData = [
                    { content: '這是左邊的假訊息，從別人發的。', side: 'left', timestamp: new Date().toLocaleString('ko-KR', { timeZone: 'Asia/Seoul' }), mosaic: false, parentId: null, level: 0, image: null },
                    { content: '這是右邊的父留言。', side: 'right', timestamp: new Date().toLocaleString('ko-KR', { timeZone: 'Asia/Seoul' }), mosaic: false, parentId: null, level: 0, image: null },
                    { content: '子留言 1 (應顯示)。', side: 'left', timestamp: new Date().toLocaleString('ko-KR', { timeZone: 'Asia/Seoul' }), mosaic: false, parentId: 2, level: 1, image: null },
                    { content: '子留言 2 (應隱藏，因只顯示 1 則)。', side: 'right', timestamp: new Date().toLocaleString('ko-KR', { timeZone: 'Asia/Seoul' }), mosaic: false, parentId: 2, level: 1, image: null },
                    { content: '這是 모자이크 訊息，包含 YouTube：https://youtu.be/dQw4w9WgXcQ。', side: 'left', timestamp: new Date().toLocaleString('ko-KR', { timeZone: 'Asia/Seoul' }), mosaic: true, parentId: null, level: 0, image: null },
                    { content: 'https://x.com/elonmusk/status/1234567890123456789', side: 'right', timestamp: new Date().toLocaleString('ko-KR', { timeZone: 'Asia/Seoul' }), mosaic: false, parentId: null, level: 0, image: null }
                ];
                const { error } = await supabase.from('messages').insert(seedData);
                if (error) console.error('Seed data insert error:', error);
                else await loadMessages();
            }
        })();
    </script>
</body>
</html>
